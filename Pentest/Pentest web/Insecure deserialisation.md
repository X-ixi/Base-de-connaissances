```toc
```


# Introduction
Ressource THM : https://tryhackme.com/r/room/insecuredeserialisation

Lorsque un composant d'une application veut envoyer des données à un autre, il est utile de sérialiser ces données, c'est-à-dire, les mettre dans un format qui permettra à l'autre composant de reconstruire facilement les données initiales (=désérialisation).

Exemple en PHP
```PHP
<?php
$noteArray = array("title" => "My THM Note", "content" => "Welcome to THM!");
$serialisedNote = serialize($noteArray);  // Converting the note into a storable format
file_put_contents('note.txt', $serialisedNote);  // Saving the serialised note to a file
?>
```
Le contenu du fichier sera : `a:2:{s:5:"title";s:12:"My THM Note";s:7:"content";s:12:"Welcome to THM!";}`

Selon le langage, différentes fonctions sont utilisés et produisent des résultats sous différents formats :
- PHP : `serialize()`, `unserialize()` (string)
- Python : `pickle.dumps()`, `pickle.loads()` (format binaire, souvent ensuite encodé en base 64)
- .NET : `serialization`
- Java : `Serializable`
- Ruby : `marshal.dump()`, `marshal.load()`


# Exploitation
## Identification
En boite blanche avec accès au code source, il suffit de rechercher l'utilisation de fonction de sérialisation et désérialisation.

En boite noire, les points suivants sont des indices :
- Message d'erreur faisant référence à de la sérialisation
- Comportements incohérents lorsque des données de cookies ou de requête POST sont modifiées
- Valeur de cookie encodée en base64, et laissant apparaître des données sérialisées une fois décodé

## Exploitation - modification de propriété
La forme d'exploitation la plus simple consiste à récupérer l'objet sérialisé, modifier une de ces propriétés, et le renvoyer au serveur.

Exemple trivial : décoder un cookie en base64, modifier la propriété `isAdmin`, puis faire la requête souhaité en tant qu'admin.

## Exploitation - injection d'objet
Si l'utilisateur a la main sur un objet sérialisé, il peut le remplacer par un autre avec les propriétés de son choix. La difficulté est de connaître la structure d'un autre objet défini dans le code et qui soit exploitable.

A noter, en PHP, la fonction `unserialize()` fait appel à la méthode `__wakeup()` de l'objet à désérialiser (c'est une "magic method"). En théorie, cela permet de remettre l'objet dans son contexte d'utilisation : ré-instauration de la connexion à la bdd, ... En pratique, cela peut être exploité par un attaquant qui créera l'objet avec les propriétés de son choix et attendra que sa méthode `__wakeup()` s'exécute.

Pour aller plus loin, il est créer un objet qui en appellera un autre, qui lui même en appellera un autre, etc. On parle alors de **chaîne de gadgets**.

Des outils permettent de faciliter leur identification et leur création. Par exemple `phpggc` pour PHP et `Ysoserial` pour Java.