Cours fait par Cogiceo (Pierre Delannoy, p18)

``` toc

```

# 1. Active Directory 

## 1.1. C'est quoi ?
Système d'annuaire permettant de gérer la configuration des machines et d'utilisateurs de manière centralisée (politique de sécurité, politique de mot de passe).
-> Cela se fait depuis un ordinateur central : le **contrôleur de domaine** (DC).

Ca permet de gérer des milliers d'utilisateurs et de machines.
-> Utiliser dans la majorité des entreprises

Apparu au sein de Windows 2000 Server, orienté très opérationnel et avec des failles de sécurité par conception (pas orienté sécu).
Si l'AD est mal configuré, il y a des secrets éparpillés partout sur les machines et les attaquants peuvent facilement les trouver après avoir compromis une machine.


Un annuaire est appelé un **domaine**. Si plusieurs domaines cohabitent (relation de confiance entre domaines), on parle de **forêt**.
On peut configurer 2 domaines de la même forêt pour qu'ils s'autorisent à accéder au machines de l'autre domaine, etc.

L'annuaire est stocké dans une base nommé *NTDS.dit* sur les contrôleurs de domaine (et répliqués sur tous les DC).


## 1.2. Machines : DCs, serveurs et PDT
DC : contrôleur de domaine 
-> cible finale

Serveurs : postes Windows qui hébergent un service ou une application
-> cible intermédiaire

Postes de travail : utilisé par les collaborateurs, souvent individuels et souvent mal sécurisés
-> cible moins intéressante

Machines obsolètes :
- Windows Server 2008R2 (et 2012R2 maintenant) et antérieur
- Windows 8.1 et antérieur


## 1.3. Utilisateurs
Les utilisateurs et leur mot de passe sont également des cibles de choix. 
Récupérer un mdp donne un point d'entrée à un attaquant.

4 grands types de comptes dans un AD :
- **Utilisateurs "standards" du domaine** (permet de se connecter à toute machine du domaine)
  -> authentification faite par l'AD
- Managed Service Accounts (MSA)
- Group Managed Service Accounts (gMSA)
- **Compte locaux** : permet de se connecter à une seule machine
  -> authentification faite par la machine

Les MSA et gMSA sont géré par l'AD sans interaction des utilisateurs.

Chaque machine du domaine a un DC privilégié auquel elle se rattache pour faire les authentification des utilisateurs, on parle de LOGONSERVER.


4 niveaux de privilège :
- **Admin de domaine** : peut tout administrer -> revient à compromettre le DC
- **Admin de serveur** : droit d'administration sur un ou plusieurs serveurs
- Admin de compte : droit de modifier un ou plusieurs autres comptes (mdp, ...)
- **Utilisateur simple**


## 1.4. Criticité
| Criticité  | Utilisateur                        | Machine          |
| ---------- | ---------------------------------- | ---------------- |
| Critique   | admin de domaine                   | DC               |
| Majeure    | admin de serveur, admin de compte  | serveur          |
| Importante | utilisateur de domaine             | poste de travail |
| Mineure    | utilisateur locaux sans privilèges |                  |


## 1.5. SID
SID : Security Identifier
`S-1-5-21-.......-.......-....330-<rid>`

`21-.......-.......-....330` : identifiant du domaine
`<rid>` : identifiant unique de la ressource

Un utilisateur de domaine "standard" a le droit de demander comment s'appelle une ressource au DC en lui donnant un SID.
-> Cela permet de faire de l'énumération (pas la meilleure méthode quand on a déjà un compte)

Raccourci de SID utile :
S-1-5-32-512 : groupe admin de domaine
S-1-5-32-513 : groupe utilisateur de domaine



# 2. Authentification

## 2.1. NTLM
Mécanisme de challenge/response, utilisé par defaut lors d'une authentification d'un client sur un serveur.
Le serveur ne peut pas vérifier que la response valide bien le challenge et doit envoyer les 2 au DC pour valider l'authentification.

MAIS, dans la base de données NTDS.dit, seul les hash des mots de passe sont stockés
-> **Seul le hash NTLM est nécessaire** pour s'authentifier


## 2.2. Kerberos
Souvent utilisé pour authentifier un utilisateur pour lui donner accès à un service.

1. Authentification auprès du DC avec mot de passe
2. Le DC vérifie les permissions et si c'est bon, il renvoie un ticket TGT
3. L'utilisateur envoie le TGT au DC
4. Le DC vérifie la validité du TGT et si c'est bon, il renvoie un ticket TGS
5. L'utilisateur envoie le TGS au service qui lui donne l'accès

Ces 2 tickets n'ont pas la même durée de validité : TGT est valide plus longtemps et permet de renouveler les TGS sans entrer son mot de passe.

Le TGT est chiffré avec le hash NT du mot de passe du compte de service Kerberos : *krbtgt*.
-> Un attaquant qui possède le hash NT peut se forger des TGT valides pour n'importe quel utilisateur : attaque *Golden ticket*.

Le TGS est chiffré avec le hash NT du mot de passe du compte qui exécute le service
-> Si l'attaquant le casse, il obtient le mot de passe du service : attaque *Kerberoast*.



# 3. Autres info utiles

## 3.1. Protocoles réseaux
- *LDAP* : service exposé par les DC pour interroger / modifier l'annuaire de l'AD (port 389)
  -> LDAP n'est pas chiffré (il faudrait utiliser LDAPS)
- *Kerberos* : authentification (port 88)
- DNS / NBT-NS / LLMNR : résolution de nom
- *SMB* : partage de ressource (port 445)
  -> SMB v1 et v2 ne sont pas chiffrés et pour tout SMB la signature est optionnelle et désactivée par défaut
- *RDP* : bureau à distance (port 3389)


## 3.2. Group Policy Objects (GPO)
Permet de configurer les politiques de sécurité et à qui elles s'appliquent.
Elles sont stockées et répliquées sur tous les DC.
Chaque machine demande à son SERVERLOGON de lui donner les GPO qu'elle doit appliquer.

Beaucoup d'attaques peuvent être empêchées par l'application de bonnes GPO.

Les utilisateurs du domaines peuvent récupérer les GPO qui les concernent et en particulier la politique de mot de passe (longueur, révocation, ...).


## 3.3. Services et tâches planifiées
Des comptes AD peuvent être utilisés pour exécuter différents services (base de données, serveur web, application mail, bureau à distance, ...). Ces comptes ont un attribut supplémentaire : Service Pincipal Name (*SPN*).
Un service de sauvegarde a besoin d'accéder à beaucoup de ressources et donc à souvent un privilège élévé, voire même admin de domaine.

Attaque *Kerberoast* : on demande un TGS pour tous les comptes qui ont un attributs SPN, puis on essaie de casser ces TGS pour retrouver les mots de passe du service.


Une tâche planifiée a souvent besoin d'accéder à des ressources sur le réseau.
-> Même problème que pour les services

Sur une machine Windows, il y a des "ruches" (=registres) qui contiennent les clés de registres (sous forme d'arbre).
Dans un AD, les ruches les plus intéressantes sont :
- SAM : contient les comptes locaux
- SECURITY : compte pour les services et les tâches planifiées
- SYSTEM : sert à déchiffrer SAM et SECURITY


## 3.4. ACL
Une ACL (Access Control List) est composée d'ACE (Access Control Entries) qui définissent les droits attribué à un objet (machine ou utilisateur). 
-> Tous les objets d'un domaine sont soumis à des ACL


## 3.5. Format de secrets
Hash LM : très faible (vieux, mdp limité à 14 caractères, tout en majuscule, ...)
-> Souvent désactivé (heureusement)
Hash NT : moyen (mdp converti en unicode puis MD4)
Hash NTLM : hash NT + hash LM
-> Pas besoin de le casser car le hash suffit

La machine garde une trace des 10 derniers comptes s'y étant connecté, pour permettre l'authentification dans le cas où le DC n'est pas joignable.
-> Hash au format *MSCachev2* (difficile à casser) dans la base SAM

**LSASS**
Processus système qui permet l'authentification des utilisateurs locaux ou du domaine sur les machines Windows.
Pour simplifier la vie de l'utilisateur (pas besoin de retaper mdp), LSASS conserve le hash NTLM et le TGT si l'utilisateur en a demandé un.

*Mimikatz* : outil open source permettant de dumper et d'analyser le contenu de la mémoire du processus LSASS : mdp et hash utilisateur, certificats et clé privée, ticket Kerberos, ...
-> Il faut être admin de la machine pour utiliser Mimikatz



# Attaques sur AD
Après une phase de cartographie/énumération, on peut s'attaquer aux machines (recherche de vulnérabilité) ou aux utilisateurs (recherche d'identifiants). Dans les 2 cas, cela permet de compromettre un système. Ensuite, on peut faire de la propagation latérale ou de l'élévation de privilège.

## Anonyme
- Ou sont les DC ?
- Quel est le nom de domaine ?
- A quoi ai-je accès anonymement ?

Ensuite, obtention d'un utilisateur de domaine, puis admin de serveur, ...
-> Toujours énumérer ce à quoi on a accès pour ne rien rater

Référence : https://adsecurity.org/

Scan réseau des ports :
- Kerberos : 88
- LDAP : 389
- 53
- HTTP : 80, 443
- SMB : 139, 445
- RDP : 3389

Les DC font souvent office de DNS aussi.

### Enumération anonyme
Si le domaine est mal configuré, on peut énumérer un certain nombre de choses.
`enum4linux -a IP_CIBLE`
`rpcclient -U "%" IP_CIBLE` (% correspond à utilisateur anonyme)
`smbclient -U "%" IP_CIBLE`

On peut essayer d'énumérer toutes les ressources en incrémentant le SID (on connait son propre SID)
-> enum4linux regarde la tranche 500-1000

Recherche de NFS accessible en anonyme (port 2049) et tentative de connexion :
`sudo showmount -e IP_CIBLE`

Si rien ne fonctionne, on fait de l'OSINT pour trouver des potentiels utilisateurs (LinkedIn, ...), et on les teste à l'aide Kerberos : lorsqu'on demande un TGT à Kerberos, il répond soit que l'utilisateur n'existe pas, soit qu'il faut entrer le mdp.
-> outil `kinit user@DOMAIN`

### Brute force
A ce stade, on a la liste des identifiants, mais pas d'accès a un compte.
On ne connait pas la politique de mot de passe car on n'a pas accès à un compte.
*Password Spraying* : on teste des mots de passe classiques sur tous les comptes (peu de tentatives pour ne pas bloquer les comptes, ex : 2 toutes les 20min, ...)
-> outil `crackmapexec` pour tester les mdp sur les SMB

A tenter :
- Mdp vide
- Mdp = login
- `<nom_entreprise><année>`
- `<ville><années>`

Si on ne trouve rien, on cherche des vulnérabilités, on fait des attaque MitM, ...

### Attaque réseau
Si NBT-NS et LLMNR sont activés, lorsqu'une requête DNS échoue, l'ordinateur de la victime demande en broadcast en NBT-NS et LLMNR à toutes les autres machines si une autre correspond à sa demande.
L'attaquant peut écouter sur le réseau et lorsqu'une machine émet en NBT-NS/LLMNR, il se fait passer pour la ressource demandée et envoie le challenge.
-> outil `responder -I eth0`

Cela n'est pas possible si les signatures SMB sont activées

LLMNR se désactive depuis les GPO mais NBT-NS doit être désactivé manuellement sur toutes les cartes réseau (donc il est souvent encore activé).


## On a un compte utilisateur
Enumérer tout ce qu'on peut :
- Dump du LDAP
- Comptes locaux avec enum4linux
- Les shares SMB / NFS
- Récupérer les GPO
- Les comptes SPN
- ...

Attaque *Kerberoast* : demande de TGT pour chaque service SPN
-> très discret car demande légitime, mais fonctionne uniquement sur des mots de passe faible 
outil `GetUsersSPN` (suite Impacket)


### Elévation de privilèges
Script d'énumération des chemins d'élévation possibles : `PowerUp`, ... 
-> Ne fonctionne que s'il n'y a pas d'antivirus car ces outils sont connus

### Post exploitation
On est administrateur de la machine, on cherche des identifiants.

On essaie de réutiliser les hash locaux sur les autres machines du réseau :
- Hash NT des comptes locaux : `crackmapexec smb IP -u user -p password --sam`
- Mdp du domaine en cache (MsCache) et mdp de comptes de service en clair : `crackmapexec smb IP -u user -p password --lsa`

Obtenir les secrets de la mémoire du process *lsass.exe* :
- Avec Mimikatz sur la machine (souvent détecté par anti-virus)
- Dump manuel de la bdd et analyse sur une autre machine

*Pass The Hash* : réutilisation d'un hash NTLM trouvé localement pour se connecter à une autre machine

Souvent, le mdp d'admin local d'un machine est aussi celui de l'admin local sur d'autres machines.


Attaque *DCSync* : profiter de compte avec les permissions "Replication Directory Change" pour demander le hash NTLM de n'importe quel compte
-> `secretsdump`
Très utile pour récupérer le hash du compte krbtgt, et faire une attaque Golden Ticket.

Attaque *Golden Ticket* : récupération du hash NT du compte krbtgt et fabrication frauduleuse d'un TGT qui donne tous les droits
-> cela permet d'être plus discret que d'utiliser un compte domaine admin (création d'un compte auprès d'un service pas relié à l'AD, ...)






## Outils
Exploitation Windows :
- Impacket : suite d'outils python
- CrackMapExec (cme) : outil de bruteforce et post exploitation
- Mimikatz

Man in the midle
- ettercap
- Responder

Cassage de mdp : John The Ripper

