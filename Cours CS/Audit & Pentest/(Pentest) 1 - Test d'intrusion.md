``` toc

```

# 1. Introduction

## 1.1. Pourquoi
Eléments que l'on peut auditer : configuration, architecture, code, organisationnel et physique.
-> Ok mais tout ça c'est du papier
=> Mise en situation réelle avec un test d'intrusion

PASSI (Prestataire d'Audit de SSI) : qualification des auditeurs (référentiel défini par l'ANSSI)
Un PASSI ne peut pas faire un test d'intrusion sans faire d'audit de conf, d'architecture, ...


## 1.2. Comment
Un audit de test d'intrusion reste un audit, donc il faut définir les éléments suivants :
- Le **périmètre** :
	- Service web
	- Réseau interne : "test du stagiaire"
	- Wifi public
	- ...
- Les **référentiels** utilisés :
	- OWASP Web Security Testing Guide
	- Notes techniques de l'ANSSI, 
	- Benchmarks du CIS (Center for Internet Security) : guide de configuration d'équipements (serveur Apache, ...)
	- ...
  -> critères d'audit
- Le **profil d'attaquant** simulé :
	- Opportuniste
	- Attaque ciblé 
	- "Étatique"

ET il faut faire une restitution

Plusieurs types de tests d'intrusion :
- **Boite noire** : aucune information sur le système à part une adresse IP
- **Boite grise** : les auditeurs ont une idée du SI derrière et ils ont un ou plusieurs comptes peu privilégiés 
	- Pivot horizontal : intéressant d'avoir 2 comptes pour tester si un compte peut accéder à / se faire passer pour l'autre
	- Pivot vertical : élévation de privilèges
- **Boite blanche** : connaissance des moindres détails du SI et un ou plusieurs comptes privilégiés (simulation d'une attaque menée par un administrateur)
	- Pivot horizontal : se faire passer pour un autre admin
	- Accéder à des données utilisateurs sensibles, faire du déni de service, ...


## 1.3. Est-ce légal ?
Oui si tout le monde est d'accord, ET que l'on reste dans le périmètre.

La convention d'audit précise :
- Depuis où : physiquement et logiquement (adresse IP)
  -> Ne pas laisser passer une attaque réelle pendant l'audit
- Quand : créneaux horaires
- Quoi : systèmes dans le périmètre (pré-prod, prod, ...)

Avant le test : pour éviter les risques, demander à l'audité de faire des sauvegardes.
Après le test : confirmation écrite que rien n'a été dégradé

Il y a des nuances juridique subtile : par exemple pour faire une campagne de phishing il faut s'assurer que l'employeur ne nuira pas à la carrière des employés ayant cliqué sur le lien, sinon on peut être accusé de complicité à pousser quelqu'un à la faute.



# 2. Étapes d'un test d'intrusion

## 2.1. Reconnaissance passive
Récupérer des informations sans interagir directement avec la cible.

Exemples : 
- Recherche avancée dans google pour filtrer sur le site cible pour trouver des fichiers cachés (pdf, backup, ...)
- Recherche de tous les virtual host sur une adresse IP (option possible dans bing)
  -> Attention : peut-être hébergement mutualisé et certains virtual host n'appartiennent pas au client et le serveur mutualisé n'est peut-être pas dans le périmètre
- Recherche DNS
- Site who.is pour avoir des info sur le site
- Recherche sur des forums, dans la presse, etc pour avoir des informations sur les technologies utilisées
=> Ce sont des techniques d'OSINT

Cette phase est rarement effectuée car elle prend trop de temps.


## 2.2. Reconnaissance active
Phase d'énumération : interaction avec la cible pour récolter des informations 

Exemples :
- Scan réseau : *nmap*
- Ecoute du réseau : *tcpdump*, *wireshark*, ...
- Exploration manuelle du site 
- Énumération des chemins du site : *dirbuster*

Il faut documenter toutes les actions faites et les résultats trouvés.


## 2.3. Exploitation
Il faut choisir lesquels des éléments trouvés précédemment sont les plus prometteurs et essayer de les exploiter.
Pas le temps de tout exploiter, mais il est important de noter les vulnérabilités suspectées malgré tout (buffer overflow qui fait crash la machine).

Beaucoup de vulnérabilités sont faciles à exploiter (Eternel Blue, log4J) car il y a des PoC en ligne (https://www.exploit-db.com/) ou regroupé dans des outils d'exploitation comme *metasploit*.


## 2.4. Persistence et pivot
Une fois dans le système, la première étape est de mettre en place une backdoor pour s'y reconnecter facilement.

Pour un site web, lorsqu'on a un shell, on a les droits de l'utilisateur qui a lancé le serveur web (par défaut www-data).
-> Il faut faire de l'élévation de privilèges.

Notes : 
- Faire un reverse-shell plutôt qu'un shell a plus de chance de fonctionner car les règles du pare-feu sont rarement configurées pour stopper les connexions venant de l'intérieur du réseau. 
- Il faut bien protéger ses accès persistant (webshell, ...) pour éviter qu'un acteur malveillant le trouve et s'en serve !

Une fois des privilèges suffisants récupérés, on peut se latéraliser sur d'autres machines
-> Une fois sur une autre machine, on retourne à une phase d'exploration pour découvrir les nouvelles machines accessibles.


# 3. Post-audit

Trois choses :
- **Restitution à chaud** avec les équipes techniques (et éventuellement la DG) pour donner un niveau global de sécurité et la présence de faille à corriger en urgence si besoin
- **Restitution à froid** plutôt orientée pour la direction avec plus de détails sur les impacts métier, sur les failles générales (mdp, conf, ...) et sur les moyens de remédiation
- **Rapport** détaillant toutes les actions réalisées, compréhensible aussi pour les personnes moins techniques

=> Important de garder un maximum de preuves pour rester impartial et factuel !




Outils :
- nmap (creuser les scripts)
- tcpdump
- wireshark
- nikto ??
- wpscan
- sqlmap
- dirbuster
- Burp
- Metasploit
- OpenVAS
Et bien plus dans Kali

Livre :
This is how they tell me the world ends
Countdown to zero day